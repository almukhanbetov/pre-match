name: Deploy to VPS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: üì• Checkout —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      uses: actions/checkout@v3

    - name: üõ° –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSH-–¥–æ—Å—Ç—É–ø–∞
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.VPS_PRIVATE_KEY }}

    - name: üöÄ –î–µ–ø–ª–æ–π –Ω–∞ VPS —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º
      run: |
        ssh -tt -o StrictHostKeyChecking=no root@${{ secrets.VPS_HOST }} << 'EOF'
          echo "[START] $(date)" >> /opt/prematch/deploy.log
          
          {
            cd /opt/prematch || exit 1

            echo "üåÄ Pull latest changes"
            git pull origin main

            echo "üõë Stopping containers"
            docker compose down

            echo "üî® Building containers"
            docker compose build

            echo "üöÄ Starting containers"
            docker compose up -d

            echo "‚úÖ Deploy complete: $(date)"
          } >> /opt/prematch/deploy.log 2>&1
          
          echo "[END] $(date)" >> /opt/prematch/deploy.log
        EOF
